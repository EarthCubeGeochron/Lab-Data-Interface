#!/usr/bin/env python
# Command to run tests
# Runs inside Docker container so we can depend on library availabilty.
import os
from sys import argv
from click import echo
from subprocess import run
from shlex import split
from time import sleep
from sqlalchemy import create_engine, exc
from sqlalchemy_utils import drop_database, create_database, database_exists
from sparrow.database.util import wait_for_database

args = argv[1:]

psql = False
if "--psql" in args:
    psql = True
    args.remove("--psql")

os.chdir("/app")

db_conn = "postgresql://postgres@db:5432/sparrow_test"
os.environ["SPARROW_DATABASE"] = db_conn

wait_for_database(db_conn)

# This prevents us from getting absolutely spammed by SAWarning
# TODO: improve warning handling for database automapping
args.append("--disable-warnings")

print("Running tests")
run(["pytest", "/app/sparrow_tests", *args])

if psql:
    echo(
        "Initializing psql shell. "
        "The database is also available on localhost port 54322"
    )
    run(["psql", *dbargs, "sparrow_test"])
