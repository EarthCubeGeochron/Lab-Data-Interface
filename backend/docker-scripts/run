#!/bin/sh

cd /app

while ! pg_isready -h db -p 5432 -U postgres ; do
  echo "Waiting for database..."
  sleep 1
done

# We no longer import EarthChem vocabularies by default

# (non-foolproof) check for whether tables exist
res=$(psql -tA -h db -p 5432 -U postgres sparrow -c "
SELECT EXISTS (
  SELECT *
  FROM information_schema.tables
  WHERE table_schema = 'public'
    AND table_name = 'datum'
);")

# Create tables if they don't exist
[ ! $res = 't' ] && python3 sparrow init

HOST=0.0.0.0
PORT=5000

#gunicorn --worker-tmp-dir /dev/shm --reload --bind 0.0.0.0:5000 -w 4 -k uvicorn.workers.UvicornWorker --log-level warning --log-file - sparrow.asgi:app
#uvicorn --debug --port 5000 --host 0.0.0.0 --access-log sparrow.asgi:app
exec uvicorn --reload --host $HOST --port $PORT --log-level warning "sparrow.asgi:app"
