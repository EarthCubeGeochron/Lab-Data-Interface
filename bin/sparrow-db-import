#!/usr/bin/env zsh
# Description: Import database from binary `pg_dump` archive
sparrow compose stop backend
sparrow db-await

internal_name=/tmp/database-dump.pg-dump
container_id=$(sparrow compose ps -q db)

sparrow compose exec -T db bash -s <<EOF
mkdir -p /tmp
rm -f "$internal_name"
EOF

docker cp "${1:A}" $container_id:$internal_name

sparrow compose exec -T db bash -s <<EOF
dropdb --if-exists -Upostgres sparrow
createdb -Upostgres sparrow
pg_restore -v -Upostgres -d sparrow $internal_name
rm -f "$internal_name"
EOF

sparrow compose start backend
