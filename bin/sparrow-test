#!/bin/bash

cd "$SPARROW_PATH/backend-tests"

# Set a different compose project name so we don't step on running
# applications.
export COMPOSE_PROJECT_NAME="sparrow_test"

function compose {
  docker-compose -f docker-compose.sparrow-tests.yaml $@
}

# First, test basic operation of command-line application
$SPARROW_PATH/_cli/_scripts/test-cli
status=$?
[ $status -ne 0 ] && echo "CLI tests failed, exiting." && exit $status

compose build --quiet

# Need to bring up database separately to ensure ports are mapped...
compose up -d db
compose run --rm --service-ports backend /bin/run-tests $@
status=$?

compose down

exit $status
